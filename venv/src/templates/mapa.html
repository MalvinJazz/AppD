{% extends 'base.html' %}

{% block title %}
  Mapa
{% endblock %}

{% block head %}
  <h1>LOCALIZACIONES</h1>
{% endblock %}

{% block content %}
<div id="sectionMap">
  <div id="map"></div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
  var map;
  var markers = [];

  function initMap() {
    if (navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position){

          var lt = position.coords.latitude;
          var lon = position.coords.longitude;

          var myLatlng = new google.maps.LatLng(lt,lon);

          map = new google.maps.Map(document.getElementById('map'), {
            center: myLatlng,
            zoom: 13
          });

          {% for dato in denuncias %}
            loc = {lat: {{dato.latitud}}, lng: {{dato.longitud}}};
            addMarker(loc, map, '{{dato.motivo}}', {{dato.getSprite}});
          {% endfor %}

        });

		} else {
			alert("Para utilizar la geolocalizaci√≥n necesitas actualizar tu navegador.");
		}
  }

  function addMarker(loc, map, title, sprite){

    var image = {
      url: '/static/images/marcadores.png',
      size: new google.maps.Size(36,46),
      origin: new google.maps.Point(sprite,0),
      anchor: new google.maps.Point(0,17)
    };
    window.setTimeout(function(){
      var marker = new google.maps.Marker({
        position: loc,
        title: title,
        map: map,
        icon: image,
        animation: google.maps.Animation.DROP
      });
      marker.addListener('click', bounceAndNull);
      markers.push(marker);
    }, sprite*30);
  }

  function bounceAndNull(){

    var flag = false;

    for(var i=0; i<markers.length; i++){
      if(markers[i].title != this.title){
        markers[i].setMap(null);
      }else{
        if (markers[i].getAnimation() !== null) {
          markers[i].setAnimation(null);
          flag = true;
        } else {
          markers[i].setAnimation(google.maps.Animation.BOUNCE);
        }
      }
    }
    if(flag){
      for(var i = 0; i<markers.length; i++){
        window.setTimeout(mostrarMarcadores(markers[i]), i*200);
      }
    }
  }

  function mostrarMarcadores(marker) {
    marker.setMap(map);
    marker.setAnimation(google.maps.Animation.DROP);
  }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPIn8C1d9dQLNNnv-Z2D0AKz6WESeZ8tI&callback=initMap"
    async defer></script>
{% endblock %}


<!-- AIzaSyAPIn8C1d9dQLNNnv-Z2D0AKz6WESeZ8tI -->
