{% extends 'base.html' %}

{% block title %}
{{municipio.nombre}}
{% endblock %}

{% block head %}
  <h1>{{municipio.nombre}}, {{municipio.departamento}}</h1>
{% endblock %}

{% block content %}
<div id="section">
  <div id="chart"></div>
  <div id = "piechart"></div>
</div>
{% endblock %}

{% block js %}
<script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">

google.charts.load('visualization', '1', {'packages': ['corechart']});
google.charts.setOnLoadCallback(draw);
$('#piechart').hide();

function draw() {
        // Some raw data (not necessarily accurate)
        var data = google.visualization.arrayToDataTable([
          ["Zona", "Denuncias"],
          {% for dato in dirs %}
            ['{{dato.direccion}}',{{dato.sumDenuncias}}],
          {% endfor %}
        ]);

    var options = {
      title : 'Denuncias del Municipio',
      hAxis: {title: 'Denuncias'},
      vAxis: {title: 'Zona'},
      bar: {groupWidth: "75%"},
      legend: { position: "none" },
      animation:{
          duration: 1500,
          easing: 'out',
          startup: true,
      },
      colors: ['#0d47a1'],
    };

    var chart = new google.visualization.BarChart(document.getElementById('chart'));
    chart.draw(data, options);

    google.visualization.events.addListener(chart, 'select', function(){

      try{
        var seleccion = chart.getSelection();
        var zona = data.getValue(seleccion[0].row, 0);

        $("#piechart").show();

        var pos = $('#piechart').offset();
        window.scrollTo(pos.left, pos.top-80);

        $.ajax({

          data: {'zona': zona},
          url: "{% url 'local:detalleZona' %}",
          type: 'get',
          success: function(data) {

            var datos = google.visualization.arrayToDataTable([
              ['Motivo', 'Denuncias'],
              {% for motivo in motivos %}
                ['{{motivo}}', data[0].mots.{{motivo}}],
              {% endfor %}
            ]);

            var opciones = {
              title: data[0].fields.direccion,
              pieHole: 0.35,
            }

            var grafica = new google.visualization.PieChart(document.getElementById('piechart'));
            grafica.draw(datos, opciones);

          }

        });
      }catch(err){

      }
    });
  }

</script>
{% endblock %}
